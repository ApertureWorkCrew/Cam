<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const emojiPre = document.getElementById('emoji');

// Color emoji mapping
const colors = [
  {emoji:"â¬›", r:0, g:0, b:0},
  {emoji:"ðŸŸ¥", r:255, g:0, b:0},
  {emoji:"ðŸŸ§", r:255, g:165, b:0},
  {emoji:"ðŸŸ¨", r:255, g:255, b:0},
  {emoji:"ðŸŸ©", r:0, g:255, b:0},
  {emoji:"ðŸŸ¦", r:0, g:0, b:255},
  {emoji:"ðŸŸª", r:128, g:0, b:128},
  {emoji:"â¬œ", r:255, g:255, b:255}
];

function getEmoji(r, g, b) {
  let closest = colors[0];
  let minDist = Infinity;
  for (const c of colors) {
    const dist = (r - c.r) ** 2 + (g - c.g) ** 2 + (b - c.b) ** 2;
    if (dist < minDist) {
      minDist = dist;
      closest = c;
    }
  }
  return closest.emoji;
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    renderLoop();
  } catch (err) {
    console.error("Camera error:", err);
  }
}

let lastSend = 0;

function renderLoop() {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imgData.data;

  let output = "";
  for (let y = 0; y < canvas.height; y++) {
    for (let x = 0; x < canvas.width; x++) {
      const i = (y * canvas.width + x) * 4;
      const r = data[i], g = data[i+1], b = data[i+2];
      output += getEmoji(r, g, b);
    }
    output += "\n";
  }
  emojiPre.textContent = output;

  const now = Date.now();
if (now - lastSend > 200) { 
  fetch("https://70fcbb8424e4.ngrok-free.app/frame", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ frame: output }) // must match server
  });
  lastSend = now;
}
  requestAnimationFrame(renderLoop);
}

startCamera();
</script>


